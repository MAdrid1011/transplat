# SAES：场景自适应早停数据流设计文档

## 1. 设计目标

设计一个场景自适应早停数据流（Scene-Adaptive Early-Stopping Dataflow, SAES），实现以下目标：

1. **反馈式早停**：在高斯生成过程中检测已生成高斯的 3D 相似性，决定是否终止后续计算
2. **跨阶段反馈**：建立从高斯生成阶段向深度预测阶段的反馈控制通路
3. **自适应粒度**：根据 3D 几何空间的局部连续性动态调整计算资源分配
4. **硬件可实现**：基于瓦片处理，流水线化设计

## 2. 核心问题：两阶段串行架构缺乏反馈

### 2.1 传统数据流的问题

```
传统流程（两阶段串行，无反馈）：

特征图 ──► 深度搜索（全部像素） ──► 高斯生成（全部像素） ──► HBM
              │                         │
              │ 必须全部完成             │ 必须全部完成
              │                         │
              └── 无法感知后续高斯相似性 ──┘
```

**问题**：
- 深度预测阶段无法知道"这些像素生成的高斯是否会相似"
- 即使高斯高度相似（3D 几何连续），也必须完整计算
- 缺乏跨阶段的信息反馈机制

### 2.2 SAES 的核心创新：反馈式早停

```
SAES 流程（反馈式早停）：

对于每个瓦片：
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│   像素 0-3 ──► 深度搜索 ──► 高斯生成 ──┐                                 │
│                                        │                                 │
│                            ┌───────────▼───────────┐                    │
│                            │  3D 高斯相似度评估     │                    │
│                            │  检查已生成高斯在      │                    │
│                            │  位置/协方差/颜色      │                    │
│                            │  等属性上的一致性      │                    │
│                            └───────────┬───────────┘                    │
│                                        │                                 │
│                     ┌──────────────────┼──────────────────┐             │
│                     ▼                  ▼                  ▼             │
│              [高相似度]          [中等相似度]        [低相似度]          │
│                     │                  │                  │             │
│                     ▼                  ▼                  ▼             │
│              ┌──────────┐      ┌──────────────┐   ┌──────────────┐     │
│              │ 早停！    │      │ 继续但降采样 │   │ 完整处理剩余 │     │
│              │ 用已生成  │      │ 像素 4-7     │   │ 像素 4-15   │     │
│              │ 高斯代表  │      │ 深度搜索     │   │             │     │
│              │ 整个瓦片  │      │ + 高斯生成   │   │             │     │
│              └──────────┘      └──────────────┘   └──────────────┘     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

**关键区别**：
- 判断依据：**已生成高斯的 3D 相似性**（而非特征相似性）
- 判断时机：**高斯生成过程中**（而非深度搜索前）
- 这才是真正感知"3D 几何空间的局部连续性"

## 3. 与 FSDR 的清晰区分

| | FSDR | SAES |
|---|---|---|
| **关注维度** | 2D 特征空间 | 3D 几何空间 |
| **判断依据** | 特征向量相似性 | 高斯基元相似性 |
| **判断时机** | 深度搜索阶段内部 | 高斯生成阶段反馈 |
| **判断对象** | 特征图 | 已生成的高斯 |
| **优化方式** | 复用已有深度结果 | 停止后续计算 |
| **优化目标** | 减少冗余访存 | 减少冗余计算 |
| **粒度** | 单点级别 | 区域级别 |

**两者互补而非稀释**：
- FSDR：在深度搜索阶段，基于 2D 特征做单点复用
- SAES：在高斯生成阶段，基于 3D 高斯做区域早停

## 4. 瓦片处理架构

### 4.1 瓦片划分

在 64×64 特征图上划分瓦片：

```
特征图 64×64，瓦片大小 T=4：
┌────┬────┬────┬────┬─···─┬────┐
│Tile│Tile│Tile│Tile│     │Tile│
│0,0 │1,0 │2,0 │3,0 │ ··· │15,0│
├────┼────┼────┼────┼─···─┼────┤
│Tile│Tile│    │    │     │    │
│0,1 │1,1 │    │    │     │    │
├────┼────┼────┼────┼─···─┼────┤
│ ⋮  │ ⋮  │    │    │     │    │
└────┴────┴────┴────┴─···─┴────┘

每个瓦片：4×4 = 16 个特征点
总瓦片数：16×16 = 256 个瓦片
上采样后：每瓦片对应 16×16 = 256 像素 → 最多 256 高斯
```

### 4.2 瓦片内处理流程（反馈式）

```
对于瓦片内 16 个像素 (编号 0-15)：

Phase 1: 探测阶段（处理前 N_probe 个像素，如 4 个）
    FOR i = 0 to N_probe-1:
        depth[i] = depth_search(feature[i])      // 深度搜索
        gaussian[i] = generate_gaussian(depth[i]) // 高斯生成
    
Phase 2: 相似度评估（基于已生成的 N_probe 个高斯）
    similarity = evaluate_3d_similarity(gaussian[0:N_probe])
    
    // 评估维度：
    // - 位置差异：max(||mean_i - mean_j||) / scene_scale
    // - 协方差差异：max(||cov_i - cov_j||) / avg_cov
    // - 颜色差异：max(||sh_i - sh_j||)
    // - 不透明度差异：max(|opacity_i - opacity_j|)
    
Phase 3: 决策与执行
    IF similarity > τ_high:  // 高相似度 → 早停
        // 用已生成的 N_probe 个高斯代表整个瓦片
        // 可选：扩大这些高斯的协方差以覆盖整个瓦片
        output = merge_and_enlarge(gaussian[0:N_probe])
        SKIP 剩余 12 个像素的计算
        
    ELIF similarity > τ_low:  // 中等相似度 → 降采样继续
        // 继续处理部分像素（如 4 个角点）
        FOR i in [5, 8, 11, 15]:  // 稀疏采样
            depth[i] = depth_search(feature[i])
            gaussian[i] = generate_gaussian(depth[i])
        output = gaussian[0:N_probe] + gaussian[稀疏采样]
        
    ELSE:  // 低相似度 → 完整处理
        FOR i = N_probe to 15:
            depth[i] = depth_search(feature[i])
            gaussian[i] = generate_gaussian(depth[i])
        output = gaussian[0:15]
```

## 5. 3D 高斯相似度评估器

### 5.1 评估指标

```python
class Gaussian3DSimilarityEvaluator:
    """评估已生成高斯在 3D 空间的相似性"""
    
    def __init__(self, scene_scale: float):
        self.scene_scale = scene_scale
        
    def evaluate(self, gaussians: List[Gaussian]) -> float:
        """
        输入: 已生成的 N_probe 个高斯
        输出: 相似度分数 (0-1)，越高表示越相似
        """
        n = len(gaussians)
        
        # 1. 位置差异
        positions = [g.mean for g in gaussians]
        max_pos_diff = max_pairwise_distance(positions) / self.scene_scale
        
        # 2. 协方差差异
        covs = [g.cov for g in gaussians]
        avg_cov_norm = mean([norm(c) for c in covs])
        max_cov_diff = max_pairwise_distance(covs) / (avg_cov_norm + eps)
        
        # 3. 颜色差异（球谐 DC 分量）
        colors = [g.sh[0:3] for g in gaussians]
        max_color_diff = max_pairwise_distance(colors)
        
        # 4. 不透明度差异
        opacities = [g.opacity for g in gaussians]
        max_opacity_diff = max(opacities) - min(opacities)
        
        # 加权离散度
        dispersion = (
            0.4 * max_pos_diff +
            0.3 * max_cov_diff +
            0.15 * max_color_diff +
            0.15 * max_opacity_diff
        )
        
        # 转换为相似度
        similarity = exp(-dispersion / 0.1)
        
        return similarity
```

### 5.2 硬件实现

```
┌────────────────────────────────────────────────────────────────┐
│           3D Gaussian Similarity Evaluator                      │
│                                                                 │
│   输入: N_probe 个高斯 (如 4 个)                                 │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  Position Comparator (6 对比较)                         │  │
│   │  计算 max(||mean_i - mean_j||)                          │  │
│   │  4 个减法器 + 6 个比较器，~4 cycles                      │  │
│   └─────────────────────────────────────────────────────────┘  │
│                           │                                     │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  Covariance Comparator (6 对比较)                       │  │
│   │  计算 max(||cov_i - cov_j||)                            │  │
│   │  ~4 cycles                                               │  │
│   └─────────────────────────────────────────────────────────┘  │
│                           │                                     │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  Color Comparator (6 对比较)                            │  │
│   │  计算 max(||sh_dc_i - sh_dc_j||)                        │  │
│   │  ~4 cycles                                               │  │
│   └─────────────────────────────────────────────────────────┘  │
│                           │                                     │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  Weighted Aggregator                                    │  │
│   │  加权求和 + exp 近似                                     │  │
│   │  ~4 cycles                                               │  │
│   └─────────────────────────────────────────────────────────┘  │
│                           │                                     │
│   输出: similarity (8-bit 定点)                                │
│                                                                 │
│   总延迟: ~16 cycles                                           │
└────────────────────────────────────────────────────────────────┘
```

## 6. 完整处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SAES Pipeline（反馈式瓦片处理）                           │
│                                                                              │
│   Backbone ────► 64×64 特征图                                               │
│                       │                                                      │
│                       ▼                                                      │
│              ┌─────────────────┐                                            │
│              │  Tile Streamer  │  按瓦片顺序读取特征                         │
│              └────────┬────────┘                                            │
│                       │                                                      │
│   ┌───────────────────┼───────────────────────────────────────────────────┐ │
│   │                   ▼                                                    │ │
│   │   Phase 1: 探测阶段（处理前 4 个像素）                                  │ │
│   │   ┌────────────────────────────────────────────────────────────────┐  │ │
│   │   │  Pixel 0-3 ──► Depth Search ──► Gaussian Generate              │  │ │
│   │   │                     │                  │                        │  │ │
│   │   │              (FSDR 可在此复用)    ┌─────▼─────┐                  │  │ │
│   │   │                                  │ Gaussian  │                  │  │ │
│   │   │                                  │ Buffer    │                  │  │ │
│   │   │                                  │ (4 个)    │                  │  │ │
│   │   │                                  └─────┬─────┘                  │  │ │
│   │   └────────────────────────────────────────┼────────────────────────┘  │ │
│   │                                            │                           │ │
│   │   Phase 2: 相似度评估                       ▼                           │ │
│   │   ┌────────────────────────────────────────────────────────────────┐  │ │
│   │   │            3D Gaussian Similarity Evaluator                    │  │ │
│   │   │                                                                 │  │ │
│   │   │   已生成的 4 个高斯 ──► 评估 3D 相似性 ──► similarity score     │  │ │
│   │   └────────────────────────────────────────┬───────────────────────┘  │ │
│   │                                            │                           │ │
│   │   Phase 3: 决策与执行                       ▼                           │ │
│   │   ┌────────────────────────────────────────────────────────────────┐  │ │
│   │   │                    Decision Controller                         │  │ │
│   │   │                                                                 │  │ │
│   │   │    IF similarity > 0.85:      // 高相似度                      │  │ │
│   │   │        ──► Early Stop Path                                     │  │ │
│   │   │        扩大已生成高斯的协方差，输出到 HBM                       │  │ │
│   │   │        跳过剩余 12 个像素                                       │  │ │
│   │   │                                                                 │  │ │
│   │   │    ELIF similarity > 0.6:     // 中等相似度                    │  │ │
│   │   │        ──► Sparse Continue Path                                │  │ │
│   │   │        继续处理 4 个稀疏采样像素                                │  │ │
│   │   │                                                                 │  │ │
│   │   │    ELSE:                      // 低相似度                      │  │ │
│   │   │        ──► Full Continue Path                                  │  │ │
│   │   │        继续处理剩余 12 个像素                                   │  │ │
│   │   └────────────────────────────────────────────────────────────────┘  │ │
│   │                                                                        │ │
│   └────────────────────────────────────────────────────────────────────────┘ │
│                       │                                                      │
│                       ▼                                                      │
│              ┌─────────────────┐                                            │
│              │  Output Buffer  │                                            │
│              │  + HBM Write    │                                            │
│              └─────────────────┘                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 7. 硬件架构详细设计

### 7.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           SAES Hardware Architecture                             │
│                                                                                  │
│   ┌──────────────┐                                                              │
│   │   Feature    │                                                              │
│   │   Buffer     │ ──► 当前瓦片 16 个特征                                       │
│   │   (4 KB)     │                                                              │
│   └──────────────┘                                                              │
│          │                                                                       │
│          ▼                                                                       │
│   ┌──────────────────────────────────────────────────────────────────────────┐  │
│   │                      Tile Processing Unit (TPU)                           │  │
│   │                                                                           │  │
│   │   ┌─────────────────────────────────────────────────────────────────┐    │  │
│   │   │                  Probe Stage Controller                          │    │  │
│   │   │   控制前 N_probe 个像素的处理                                    │    │  │
│   │   └─────────────────────────────────────────────────────────────────┘    │  │
│   │          │                                                                │  │
│   │          ▼                                                                │  │
│   │   ┌──────────────────────────────────────────────────────────────────┐   │  │
│   │   │              Depth Search Unit (可与 FSDR 集成)                   │   │  │
│   │   │   ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                            │   │  │
│   │   │   │ DSU0 │ │ DSU1 │ │ DSU2 │ │ DSU3 │  (4个并行深度搜索单元)      │   │  │
│   │   │   └──────┘ └──────┘ └──────┘ └──────┘                            │   │  │
│   │   └──────────────────────────────────────────────────────────────────┘   │  │
│   │          │                                                                │  │
│   │          ▼                                                                │  │
│   │   ┌──────────────────────────────────────────────────────────────────┐   │  │
│   │   │              Gaussian Generator                                   │   │  │
│   │   │   深度 + 特征 ──► 高斯参数 (mean, cov, opacity, sh)              │   │  │
│   │   └──────────────────────────────────────────────────────────────────┘   │  │
│   │          │                                                                │  │
│   │          ▼                                                                │  │
│   │   ┌──────────────────────────────────────────────────────────────────┐   │  │
│   │   │              Probe Gaussian Buffer (存储探测阶段的高斯)           │   │  │
│   │   │   4 × 120B = 480B                                                 │   │  │
│   │   └──────────────────────────────────────────────────────────────────┘   │  │
│   │          │                                                                │  │
│   │          ▼                                                                │  │
│   │   ┌──────────────────────────────────────────────────────────────────┐   │  │
│   │   │              3D Similarity Evaluator                              │   │  │
│   │   │   评估 4 个高斯在 3D 空间的相似性                                 │   │  │
│   │   │   输出: similarity score                                          │   │  │
│   │   └──────────────────────────────────────────────────────────────────┘   │  │
│   │          │                                                                │  │
│   │          ▼                                                                │  │
│   │   ┌──────────────────────────────────────────────────────────────────┐   │  │
│   │   │              Decision Controller                                  │   │  │
│   │   │                                                                   │   │  │
│   │   │   ┌───────────────┐ ┌───────────────┐ ┌───────────────┐          │   │  │
│   │   │   │  Early Stop   │ │    Sparse     │ │     Full      │          │   │  │
│   │   │   │    Path       │ │   Continue    │ │   Continue    │          │   │  │
│   │   │   │ (sim > 0.85)  │ │ (0.6-0.85)    │ │  (sim < 0.6)  │          │   │  │
│   │   │   └───────────────┘ └───────────────┘ └───────────────┘          │   │  │
│   │   └──────────────────────────────────────────────────────────────────┘   │  │
│   │                                                                           │  │
│   └───────────────────────────────────────────────────────────────────────────┘  │
│          │                                                                       │
│          ▼                                                                       │
│   ┌──────────────┐                                                              │
│   │ Output FIFO  │ ──► HBM                                                      │
│   └──────────────┘                                                              │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 各路径执行时序

#### Early-Stop 路径（高 3D 相似度）

```
时间轴 (cycles):
0          100        116        140        ~150
│──────────│──────────│──────────│──────────│
│ 4像素    │ 相似度   │ 高斯扩大  │ 输出    │
│ 完整处理 │ 评估     │ + 合并   │          │
│ (100)    │ (16)     │ (24)     │ (10)     │

总时间: ~150 cycles
输出高斯: 4 个（扩大后覆盖整个瓦片）
跳过: 12 个像素的深度搜索 + 高斯生成
```

#### Sparse Continue 路径（中等 3D 相似度）

```
时间轴 (cycles):
0          100        116        216        ~250
│──────────│──────────│──────────│──────────│
│ 4像素    │ 相似度   │ 4像素    │ 输出    │
│ 完整处理 │ 评估     │ 稀疏处理 │          │
│ (100)    │ (16)     │ (100)    │ (34)     │

总时间: ~250 cycles
输出高斯: 8 个
跳过: 8 个像素的深度搜索 + 高斯生成
```

#### Full Continue 路径（低 3D 相似度）

```
时间轴 (cycles):
0          100        116        416        ~500
│──────────│──────────│──────────│──────────│
│ 4像素    │ 相似度   │ 12像素   │ 输出    │
│ 完整处理 │ 评估     │ 完整处理 │          │
│ (100)    │ (16)     │ (300)    │ (84)     │

总时间: ~500 cycles
输出高斯: 16 个（上采样后 256 个）
跳过: 无
```

## 8. 与 FSDR 的协同

SAES 与 FSDR 在数据流中协同工作：

```
┌─────────────────────────────────────────────────────────────────────┐
│                    FSDR + SAES 协同架构                             │
│                                                                      │
│   特征图 ──► 按瓦片处理                                             │
│                │                                                     │
│   ┌────────────┼────────────────────────────────────────────────┐   │
│   │ Phase 1    │                                                 │   │
│   │            ▼                                                 │   │
│   │   像素 0-3 ──► FSDR 缓存查询                                 │   │
│   │                │                                             │   │
│   │           ┌────┴────┐                                        │   │
│   │           │ 命中?   │                                        │   │
│   │           └────┬────┘                                        │   │
│   │      是 ◄──────┼──────► 否                                   │   │
│   │      │         │                                             │   │
│   │      ▼         ▼                                             │   │
│   │   复用深度   完整深度搜索                                     │   │
│   │      │         │                                             │   │
│   │      └────┬────┘                                             │   │
│   │           ▼                                                  │   │
│   │   高斯生成 ──► 存入 Probe Buffer                             │   │
│   └────────────┼─────────────────────────────────────────────────┘   │
│                │                                                     │
│   ┌────────────┼────────────────────────────────────────────────┐   │
│   │ Phase 2    ▼                                                 │   │
│   │   3D 相似度评估（基于 Probe Buffer 中的 4 个高斯）           │   │
│   └────────────┼─────────────────────────────────────────────────┘   │
│                │                                                     │
│   ┌────────────┼────────────────────────────────────────────────┐   │
│   │ Phase 3    ▼                                                 │   │
│   │   ┌─────────────────────────────────────────────────────┐   │   │
│   │   │ 高相似度 → 早停                                      │   │   │
│   │   │   不再触发 FSDR，跳过剩余计算                        │   │   │
│   │   │                                                      │   │   │
│   │   │ 中等相似度 → 稀疏继续                               │   │   │
│   │   │   剩余 4 个像素可利用 FSDR                          │   │   │
│   │   │                                                      │   │   │
│   │   │ 低相似度 → 完整继续                                 │   │   │
│   │   │   剩余 12 个像素可利用 FSDR                         │   │   │
│   │   └─────────────────────────────────────────────────────┘   │   │
│   └──────────────────────────────────────────────────────────────┘   │
│                │                                                     │
│                ▼                                                     │
│              HBM                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**协同策略**：
1. **FSDR 在探测阶段生效**：前 4 个像素的深度搜索可利用 FSDR 缓存
2. **SAES 决定后续处理**：基于已生成高斯的 3D 相似性决定是否早停
3. **FSDR 在继续阶段生效**：若 SAES 决定继续，剩余像素仍可利用 FSDR

## 9. 硬件资源估算

| 组件 | 资源 | 说明 |
|-----|------|-----|
| **Feature Buffer** | 4 KB SRAM | 当前瓦片 16 个特征 |
| **Probe Gaussian Buffer** | 0.5 KB SRAM | 4 个探测高斯 |
| **DSU ×4** | ~8K LUT + 32 乘法器 | 深度搜索（与 FSDR 共享） |
| **Gaussian Generator** | ~2K LUT | 参数计算 |
| **3D Similarity Evaluator** | ~1.5K LUT | 位置/协方差/颜色比较 |
| **Decision Controller** | ~200 LUT | 阈值比较 + 状态机 |
| **Output FIFO** | 4 KB SRAM | 输出缓冲 |
| **控制逻辑** | ~500 LUT | 流水线控制 |
| **总 SRAM** | **~9 KB** | |
| **总 LUT** | **~12K** | |
| **面积估算** | **~0.3 mm² (28nm)** | |
| **功耗估算** | **~50 mW** | |

## 10. 预期效果

### 10.1 计算节省

| 路径 | 触发条件 | 像素处理量 | 计算节省 |
|------|---------|-----------|---------|
| Early-stop | 3D 相似度 > 0.85 | 4/16 = 25% | **75%** |
| Sparse Continue | 0.6 < 相似度 ≤ 0.85 | 8/16 = 50% | **50%** |
| Full Continue | 相似度 ≤ 0.6 | 16/16 = 100% | 0% |

**综合节省**（假设 30%/40%/30% 分布）：
- 计算节省: 0.3×75% + 0.4×50% + 0.3×0% = **42.5%**

### 10.2 与 Challenge 2 的对应

| Challenge 2 问题 | SAES 解决方案 |
|-----------------|--------------|
| 两阶段串行架构 | 引入跨阶段反馈机制 |
| 缺乏反馈 | 在高斯生成阶段评估 3D 相似性 |
| 忽视 3D 几何连续性 | 基于已生成高斯的 3D 属性判断 |
| 无法调整计算粒度 | 三级路径（早停/稀疏/完整） |

### 10.3 渲染质量评估

| 场景类型 | PSNR 变化 | SSIM 变化 | 说明 |
|---------|----------|----------|------|
| 平滑区域（墙壁） | -0.1 dB | -0.005 | 高斯扩大影响极小 |
| 中等区域（物体表面） | -0.2 dB | -0.01 | 稀疏采样引入轻微误差 |
| 复杂区域（边缘） | 0 dB | 0 | 完整处理无损失 |
| **平均** | **-0.15 dB** | **-0.007** | 可接受的质量损失 |

## 11. 总结

SAES 通过以下关键创新实现 3D 几何空间连续性的利用：

1. **反馈式架构**：在高斯生成过程中评估已生成高斯的 3D 相似性，而非在深度搜索前评估特征
2. **跨阶段反馈**：建立从高斯生成阶段向深度预测阶段的控制通路
3. **真正的 3D 感知**：基于高斯在位置、协方差、颜色等 3D 属性上的相似性决策
4. **自适应粒度**：三级路径（早停/稀疏/完整）适应不同的 3D 连续性程度

**与 FSDR 的互补关系**：

| | FSDR | SAES |
|---|---|---|
| 关注维度 | 2D 特征空间 | 3D 几何空间 |
| 优化目标 | 减少冗余访存 | 减少冗余计算 |
| 判断时机 | 深度搜索前 | 高斯生成后 |
| 粒度 | 单点级别 | 区域级别 |

两者协同工作，分别从**访存**和**计算**两个维度优化可泛化 3DGS 编码器的效率。
