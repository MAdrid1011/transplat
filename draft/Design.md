# GeoPIM：面向前馈3DGS生成Encoder的几何感知存内计算架构

## GeoPIM 数据流

为解决前馈 3DGS Encoder 在几何引导采样阶段面临的低带宽利用率与中间数据放大两大瓶颈，本文提出 GeoPIM——一种将几何语义显式编码于存内计算架构的加速方案。与传统 GPU 执行流程不同，GeoPIM 将几何引导采样与加权聚合的核心计算前移至 HBM 侧，通过语义感知的预取机制与流水化的融合数据流，在内存端直接完成从特征图到聚合输出的端到端处理。

GeoPIM 的核心设计原则是：**PIM 专注于"大带宽 + 轻计算"的优势**，将计算密集的权重生成（包括 Q-K attention）保留在 GPU 侧，而将内存受限的采样与聚合下推至 HBM 内部执行。

GeoPIM 的数据流由 Host GPU 与 HBM-PIM 协同执行，分为五个主要阶段。

### Stage 1: 几何参数计算与下发

GeoPIM 的数据流始于 Host GPU 端的几何参数计算。几何引导采样的核心特征是：采样位置由相机参数与深度候选确定，而非规则的二维网格。GPU 根据采样策略计算几何参数，包括：

- **极线采样**：基于基础矩阵确定每个 query 像素在参考视图上的极线方程
- **重投影采样**：基于相机投影矩阵与离散深度候选生成参考采样位置

GeoPIM 通过紧凑的参数描述符统一表示不同采样策略，包含采样参考区域、采样数量、偏移范围边界以及对应的 query 索引。该阶段的计算量极小，数据传输量亦可忽略（~4KB），因此不构成性能瓶颈。

### Stage 2: 权重预计算（统一在 GPU 侧）

**所有方法的注意力权重都在 GPU 侧预计算**，这是 GeoPIM 区别于其他 PIM 方案的关键设计选择，也是实现 Challenge 中提出的"流式采样–聚合融合"的前提。

对于权重与采样值解耦的方法（如 TransPlat 的 Deformable Attention），权重由 query 特征通过 MLP 直接预测，可在采样前预先计算。

对于权重依赖采样值的方法（如 PixelSplat 的 Cross-Attention），GPU 首先执行轻量级的 key 采样获取低维特征，计算 Q-K score 并完成 softmax 归一化，生成最终的注意力权重。

**这一设计选择的理由**：
1. **硬件简化**：PIM 无需 exp/div 等复杂运算单元，满足 <10K gates/bank 的约束
2. **路径统一**：所有方法都走"预计算权重 + 加权累加"的统一数据流，简化 PIM 侧逻辑
3. **发挥优势**：GPU 擅长计算密集的权重生成，PIM 擅长带宽密集的采样聚合

### Stage 3: 几何感知预取与地址生成

当 PIM 控制器接收到几何参数后，在 HBM 侧启动几何感知的预取流程。该阶段的核心任务是将几何语义转化为可被硬件利用的访存模式。

对于每个 query，PIM 单元通过并行地址生成单元计算采样坐标序列。由于双线性插值需要访问每个采样点的四邻域像素，地址生成单元进一步将浮点坐标转换为整数坐标及对应的 HBM 线性地址。

GeoPIM 采用 **Row Buffer Aware** 的调度策略，而非 per-bank cache：
- 将采样区域相近的 queries 分配到同一 bank
- 同一 bank 内的 queries 按采样区域排序
- 最大化 DRAM row buffer 的复用

### Stage 4: 存内融合采样-聚合

Stage 4 是 GeoPIM 数据流的核心执行阶段。该阶段采用 **C-Tiling** 策略处理高维特征向量：

- 将 C=128 维特征分为 16 个 tile（每 tile 8 channels）
- 每个 tile 的 4 邻域数据仅需 64B（1 个 HBM burst）
- 使用 **Ping-Pong Buffer** 隐藏 DRAM 访问延迟

融合执行对每个采样点依次完成：

1. **坐标计算**：根据几何参数计算采样坐标
2. **地址生成**：生成四邻域地址，计算双线性插值权重
3. **数据获取**：从 DRAM 获取 tile 数据（利用 ping-pong 隐藏延迟）
4. **插值累加**：双线性插值 + 与预计算权重相乘 + 累加

当一个 query 的全部采样点处理完毕后，累加器中的结果即为该 query 的最终聚合输出，无需任何中间数据的 HBM 写回。

### Stage 5: 结果回传与后处理

在 PIM 完成所有 query 的几何引导采样-聚合后，将紧凑的输出张量（~4MB）传回 Host GPU。相比原始中间张量（~2GB），压缩了约 500 倍。

## GeoPIM 架构设计

### Overview

GeoPIM 采用 Host GPU 与 PIM-HBM 协同构成的异构系统架构。关键设计约束：

| 约束 | 规格 | 说明 |
|------|------|------|
| 工艺节点 | 28nm | 匹配 HBM-PIM |
| 门级预算 | **<10K gates/bank** | 最关键约束 |
| 功耗限制 | **<1mW/bank** | HBM 热设计 |

### PIM-HBM 核心组件

GeoPIM 在 HBM 的每个 Bank 侧集成了极简的 PIM 单元（~9.5K gates）：

**几何地址生成器（~2K gates）**：
- 参数寄存器（128B）
- FP16 坐标计算单元
- 地址转换逻辑

**Tile Buffer（~1K gates）**：
- 256B Ping-Pong buffer
- 支持 4 邻域 × 8 channels × FP16

**计算单元（~5K gates）**：
- **8-lane FP16 MAC**（时分复用处理 C=128）
- 16 个 FP32 累加寄存器
- 双线性插值 + 加权累加逻辑

**控制逻辑（~1.5K gates）**：
- 状态机
- Tile/Sample 计数器


这种通用设计使 GeoPIM 可作为前馈 3DGS Encoder 的**通用加速器**，适用于当前及未来的几何引导采样方法。
